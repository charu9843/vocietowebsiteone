<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üé§ Tamil Website Builder</title>
  <!-- Stop the favicon 404 warning -->
  <link rel="icon" href="data:,">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 16px; }
    button { padding: 8px 12px; font-size: 16px; cursor: pointer; }
    #progress-container {
      width: 100%;
      background: #eee;
      height: 25px;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    #progress-bar {
      width: 0%;
      background: #4caf50;
      height: 100%;
      color: white;
      text-align: center;
      line-height: 25px;
      font-size: 14px;
      transition: width 0.3s ease;
      white-space: nowrap;
    }
    .muted { color:#666; font-size:14px; }
    .error { color:#c0392b; }
    .ok { color:#2e7d32; }
  </style>
</head>
<body>
  <h2>üé§ Speak in Tamil about the Website You Want</h2>

  <div id="progress-container"><div id="progress-bar">0%</div></div>

  <button id="mic-btn" onclick="startListening()">üéôÔ∏è Start Mic</button>
  <span class="muted">Use Chrome for best results.</span>

  <p id="tamil-output">üìù Tamil: </p>
  <p id="intent-output">üéØ Intent: </p>
  <p id="result-output">üì¶ Result: </p>

  <button id="view-site-btn" style="display:none;" onclick="viewWebsite()">üëÅÔ∏è View Website</button>
  <button id="download-btn" style="display:none;" onclick="downloadSite()">‚¨áÔ∏è Download Generated Site</button>

  <script>
    // ---- Helpers ------------------------------------------------------------
    function updateProgress(percent, label) {
      const bar = document.getElementById('progress-bar');
      bar.style.width = percent + '%';
      bar.textContent = label ? `${percent}% - ${label}` : percent + '%';
    }

    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!res.ok) {
        // Surface HTTP errors clearly (e.g., 403/500 from Azure)
        const text = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} on ${url}${text ? `: ${text.slice(0,200)}` : ''}`);
      }
      return res.json();
    }

    function setButtonsVisible(visible) {
      document.getElementById("view-site-btn").style.display = visible ? 'inline-block' : 'none';
      document.getElementById("download-btn").style.display = visible ? 'inline-block' : 'none';
    }

    function showError(msg) {
      const el = document.getElementById("result-output");
      el.classList.add('error');
      el.textContent = `‚ùå ${msg}`;
      updateProgress(0, 'Error');
    }

    // ---- Main flow ----------------------------------------------------------
    function startListening() {
      setButtonsVisible(false);
      updateProgress(0, 'Checking mic‚Ä¶');

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        showError("Speech recognition is not supported in this browser. Please use Chrome.");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = 'ta-IN';          // Tamil
      recognition.interimResults = false;  // final results only
      recognition.continuous = false;      // avoid duplicate triggers

      recognition.onstart = function() {
        updateProgress(10, 'Listening‚Ä¶ talk now');
      };

      recognition.onresult = async function(event) {
        try {
          const results = event.results;
          const transcript = results[results.length - 1][0].transcript.trim();
          if (!transcript) return;

          const tamilText = transcript;
          document.getElementById("tamil-output").innerText = "üìù Tamil: " + tamilText;
          updateProgress(25, 'Tamil recognized');

          // Step 1: intent
          const intentResp = await postJSON('/intent', { tamilText });
          if (!intentResp.success) throw new Error('Intent detection failed');
          const intent = intentResp.intent;
          document.getElementById("intent-output").innerText = "üéØ Intent: " + intent;
          updateProgress(55, 'Intent detected');

          // Step 2: generate code
          const genResp = await postJSON('/generate-code', { intent });
          if (!genResp.success) throw new Error(genResp.error || 'Code generation failed');

          document.getElementById("result-output").innerHTML =
            "üì¶ Code files generated:<br>" + (genResp.files || []).join("<br>");
          document.getElementById("result-output").classList.remove('error');
          document.getElementById("result-output").classList.add('ok');

          updateProgress(90, 'Code generated');
          setButtonsVisible(true);
          updateProgress(100, 'Ready to view and download');
        } catch (err) {
          console.error(err);
          showError(err.message || "Unexpected error");
        }
      };

      recognition.onerror = function(event) {
        showError(`Speech recognition error: ${event.error || 'unknown'}`);
      };

      recognition.onend = function() {
        // You can restart automatically if you want persistent listening
      };

      recognition.start();
    }

    function viewWebsite() {
      // Assumes Express serves /preview from generated-site/
      window.open('/preview/index.html', '_blank');
    }

    function downloadSite() {
      window.location.href = '/download';
    }
  </script>
</body>
</html>
